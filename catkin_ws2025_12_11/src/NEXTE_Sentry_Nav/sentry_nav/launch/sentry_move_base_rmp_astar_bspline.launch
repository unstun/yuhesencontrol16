<launch>
  <!-- ========= 一些可调参数 ========= -->
  <!-- 2D 地图坐标系，在 sentry_localize_urdf_traversability.launch 里是 2d_map -->
  <arg name="global_frame"      default="2d_map" />
  <!-- 机器人 2D 座标系，在 trans_tf_2d 里是 body_2d -->
  <arg name="base_frame"        default="base_footprint" />
  <!-- map_server 发布的 2D 地图话题名：prior_map -->
  <arg name="map_topic"         default="prior_map" />
  <!-- 车身里程计话题名，你之前用的是 Odometry -->
  <arg name="odom_topic"        default="Odometry" />
  <!-- move_base 输出的速度话题，后面会被 velocity_smoother_ema 接过去 -->
  <arg name="cmd_vel_topic"     default="/raw_cmd_vel" />
  <!-- 是否仿真时间，真车跑就设 false，回放 bag 就 true -->
  <arg name="use_sim_time"      default="false" />

  <param name="use_sim_time" value="$(arg use_sim_time)" />


  <!-- ================== 1. move_base + RMP 导航核心节点 ================== -->
  <node pkg="move_base" type="move_base"
        name="move_base_rmp"
        output="screen" clear_params="true">

    <!-- 1.1 话题重映射：让 move_base 和你现有系统对上号 -->
    <!-- costmap 的 static_map layer 默认订阅 /map，这里把它重定向到 prior_map -->
    <remap from="map"  to="$(arg map_topic)" />
    <!-- move_base 默认看 /odom，这里重定向到你车上的 /Odometry -->
    <remap from="odom" to="$(arg odom_topic)" />
    <!-- move_base 默认发布 /cmd_vel，这里改成 /raw_cmd_vel，给速度平滑器用 -->
    <remap from="/cmd_vel" to="$(arg cmd_vel_topic)" />

    <!-- 1.2 显式指定全局/局部 costmap 的坐标系 -->
    <param name="global_costmap/global_frame"      value="$(arg global_frame)" />
    <param name="global_costmap/robot_base_frame"  value="$(arg base_frame)" />
    <param name="local_costmap/global_frame"       value="$(arg global_frame)" />
    <param name="local_costmap/robot_base_frame"   value="$(arg base_frame)" />

    <!-- 1.3 代价地图参数：复用你原来 sentry_nav 那套配置 -->
    <rosparam file="$(find sentry_nav)/param/costmap_common_params.yaml"
              command="load" ns="global_costmap" />
    <rosparam file="$(find sentry_nav)/param/costmap_common_params.yaml"
              command="load" ns="local_costmap" />
    <rosparam file="$(find sentry_nav)/param/global_costmap_params.yaml"
              command="load" />
    <rosparam file="$(find sentry_nav)/param/local_costmap_params.yaml"
              command="load" />

    <!-- ================== 2. 全局规划相关参数（保留原来的 sim_env 配置） ================== -->
    <rosparam file="$(find sim_env)/config/planner/common_planner_params.yaml"
              command="load" />
    <rosparam file="$(find sim_env)/config/planner/graph_planner_params.yaml"
              command="load" />

    <!-- ================== 3. MPC 局部控制器（TU Dortmund carlike） ================== -->
    <!-- 加载 TU Dortmund carlike 的 MPC 参数（里面已经是 robot.type = simple_car） -->
    <rosparam file="$(find mpc_local_planner_examples)/cfg/carlike/mpc_local_planner_params.yaml"
              command="load" />

    <!-- 确保 base_local_planner 用 mpc_local_planner -->
    <param name="base_local_planner" value="mpc_local_planner/MpcLocalPlannerROS" />

    <!-- 适当设置控制频率（可以沿用你原来的 10Hz） -->
    <param name="controller_frequency" value="10.0" />
    <param name="controller_patience"  value="15.0" />

    <!-- 阿克曼车不能原地旋转 -->
    <param name="clearing_rotation_allowed" value="false" />

    <!-- 可选：是否发布 OCP 结果，用于调参画图 -->
    <param name="MpcLocalPlannerROS/controller/publish_ocp_results" value="false" />

    <!-- ================== 4. move_base 通用参数 ================== -->
    <rosparam file="$(find sim_env)/config/move_base_params.yaml"
              command="load" />

    <!-- ================== 5. 告诉 move_base 用哪个全局规划插件 ================== -->
    <!-- ★★★ 全局规划：直接使用 Hybrid A* 插件 ★★★ -->
    <param name="base_global_planner" value="hybrid_astar_planner/HybridAStarPlanner" />

    <!-- 告诉插件使用 Hybrid A*（插件里会读取这个参数） -->
    <param name="use_hybrid_astar" value="true" />

    <!-- 注意：cmd_vel 还是会交给 mpc_local_planner 去算，上面已经把 /cmd_vel remap 成 /raw_cmd_vel 了 -->
  </node>


  <!-- ================== 6. TF 和速度平滑器 ================== -->

  <!-- 如果在其他 launch 里已经起过 trans_tf_2d，这里就不要再起 -->
  <!--
  <node pkg="sentry_nav" type="trans_tf_2d" name="trans_tf_2d" output="screen" />
  -->

  <!-- 速度平滑器：订阅 /raw_cmd_vel，发布 /cmd_vel，最后由 sentry_kinematics_bridge 订阅 -->
  <include file="$(find velocity_smoother_ema)/launch/velocity_smoother_ema.launch" />


  <!-- ================== 7. 不再使用 Python Reeds-Shepp 平滑器 ================== -->
  <!--
  <node pkg="sentry_rs_path"
        type="reeds_shepp_smoother.py"
        name="reeds_shepp_smoother"
        output="screen">

    <param name="input_path_topic"  value="/move_base_rmp/PathPlanner/plan" />
    <param name="output_path_topic" value="/move_base_rmp/bspline_plan" />
    <param name="turning_radius" value="1.6" />
    <param name="step_size" value="0.1" />
  </node>
  -->


  <!-- ================== 8. 轨迹可视化 ================== -->
  <node pkg="sentry_nav" type="live_trajectory_plotter.py"
        name="live_plotter" output="screen">
    <!-- 这个脚本内部现在默认画的是 /move_base_rmp/PathPlanner/plan，
         如果你以后想看到 Hybrid A* 的路径，要去脚本里把
         self.plan_topic 改成 /move_base_rmp/HybridAStarPlanner/plan -->
  </node>

</launch>

